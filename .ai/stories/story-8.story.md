# Epic-1 - Story-2
# 在线规则同步与法规集隔离缓存

**As a** 合规工具使用者/CI 运维  
**I want** 通过 CLI 从在线源同步指定法规集并按法规隔离缓存  
**so that** 能一键获取最新规则（默认全量法规），且不同法规集互不覆盖、可独立更新

## Status

Draft

## Context

- 基于 PRD 更新：rulesync 需支持在线源（使用 “法规参考链接” 中的官方地址），默认同步全部法规集，支持 CLI 参数指定法规子集。  
- 本地缓存目录需按法规隔离（`~/.minos/rules/<regulation>`），仅保留最新版本覆盖旧版，并校验完整性（SHA256/可选签名）。  
- 需兼容无网/受限环境：已有缓存可离线使用；失败时不影响其他法规集。

## Estimation

Story Points: 2

## Tasks

1. - [x] 设计测试用例（TDD 先行）  
   - [x] 1.1 覆盖：默认同步全量法规、指定法规子集、按法规隔离缓存、覆盖旧版本、校验失败/网络失败、离线使用已缓存  
   - [x] 1.2 断言：缓存目录结构（~/.minos/rules/<regulation>）、仅保留最新版本、metadata 正确记录来源/版本/校验结果、退出码/日志  
   - [x] 1.3 远端同步覆盖：HTTP/git/OCI 下载成功、校验失败、超时/重试、断网失败场景  
   - [ ] 1.4 远端同步断言：下载失败不覆盖旧缓存，错误信息/退出码符合约定  
2. - [x] 实现测试用例（自动化）  
   - [x] 2.1 本地模拟在线源（本地 HTTP/文件）与法规子集参数的测试，验证缓存结构与覆盖策略  
   - [x] 2.2 覆盖校验失败/网络失败/离线缓存的退出码与日志断言  
   - [ ] 2.3 远端同步测试实现：HTTP/git/OCI 下载成功/失败/重试/断网覆盖  
3. - [x] CLI 与 rulesync 扩展  
   - [x] 3.1 新增 `--regulations` 多值参数，默认同步 PRD 法规参考链接全部法规；支持一次同步多个法规集  
   - [x] 3.2 允许以远端 source 作为参数输入（占位），调用法规隔离同步接口；实际远端下载在任务 6 实现  
   - [x] 3.3 离线模式：无网时使用已有缓存，缺失目标法规时返回非零并提示  
4. - [x] 缓存与元数据  
   - [x] 4.1 缓存目录 `~/.minos/rules/<regulation>`，仅保留最新版本；记录版本/来源/校验结果/安装时间/激活标记（按法规隔离）  
   - [x] 4.2 清理或覆盖策略：同步成功后覆盖旧版并更新 metadata；保留失败日志  
5. - [x] 文档与验收  
   - [x] 5.1 更新 README/rulesync 使用说明：在线同步、法规子集、缓存结构、离线模式示例  
   - [x] 5.2 验收用例：全量同步、指定法规、校验失败、离线使用缓存、覆盖旧版、日志与退出码（远端下载验收见任务 6）
6. - [ ] 远端在线同步实现  
   - [ ] 6.1 支持 HTTP/git/OCI 远端下载规则包到本地缓存（使用 PRD 法规参考链接）  
   - [ ] 6.2 远端下载失败重试/超时/错误提示与退出码  
   - [ ] 6.3 CLI rulesync 支持直接使用远端 source（不再要求本地 tar.gz）  
   - [ ] 6.4 容器使用说明：容器内 rulesync 远端 source 示例与网络/证书/缓存注意事项

## Constraints

- 在线源使用 PRD “法规参考链接” 的地址；支持 https/git/oci。  
- 默认同步全部法规；用户可指定子集。  
- 规则集本地隔离存储且仅保留最新版本，互不覆盖。  
- 兼容无网/受限网络，使用已有缓存。

## Structure

- `minos/cli.py` rulesync 参数扩展  
- `minos/rulesync/`：下载/校验/落地与缓存管理  
- `tests/`：规则同步与缓存结构的测试/模拟源

## Test Plan（设计）

- 默认全量同步：无 `--regulations` 时拉取 PRD 法规参考链接中的全部法规（GDPR/CCPA/CPRA/LGPD/PIPL/APPI…），每个法规对应 `~/.minos/rules/<regulation>`，仅保留最新版本。  
- 指定法规子集：如 `--regulations gdpr --regulations ccpa` 仅同步子集；其他未指定法规不应新增/覆盖。  
- 缓存覆盖与隔离：同一法规多次同步覆盖旧版本（同目录），不同法规互不覆盖；metadata 记录版本/来源/校验结果/安装时间/激活标记。  
- 校验失败/网络失败：错误时退出码非零，日志包含失败原因，已有缓存不被覆盖。  
- 离线模式：在无网或模拟失败时使用已有缓存，缺失目标法规时退出码非零并提示缺少缓存。  
- 结构验证：检查目录结构、metadata 内容、激活版本指针；确认只保留最新版本（旧版本被覆盖或清理）。
- 远端同步（HTTP）：下载成功落地并校验；校验失败不落地；超时触发重试并最终失败时退出码非零。  
- 远端同步（git/OCI）：拉取成功落地；断网/认证失败时不覆盖旧缓存并输出明确错误。  
- 远端失败恢复：上一版本缓存仍可用，离线模式可回退使用旧缓存。
- 远端同步覆盖：HTTP/git/OCI 下载成功落地、校验失败不落地、超时/重试、断网失败不覆盖旧缓存。

## Assertions（设计）

- 缓存结构：`~/.minos/rules/<regulation>` 存在且仅保留最新版本；不同法规目录互不覆盖。  
- metadata：包含 version/source/sha256/installed_at/active/status；覆盖旧版后 metadata 更新为最新版本并 active=true。  
- 退出码：成功=0；校验失败、网络失败、缺少缓存（离线）=非零；失败时不覆盖已有缓存。  
- 日志：stdout 摘要包含同步法规列表、目标路径；错误/校验失败日志明确原因。  
- 默认全量：无参数时同步 PRD 法规参考链接中全部法规；子集模式仅落地指定法规。  
- 离线：有缓存则使用并退出码=0；无缓存且离线时退出码非零并提示缺少缓存。
- 远端校验失败：退出码非零，metadata 不更新；旧缓存保持不变。  
- 远端超时/重试：达到重试上限后失败并提示；无部分落地。  

## Chat Command Log

- User: OK，那新建story吧  
- Assistant: 创建 Epic-1 Story-2（在线规则同步与法规集隔离缓存）草稿  
- User: [story-8.story.md](.ai/stories/story-8.story.md) 执行任务1.1  
- Assistant: 设计测试覆盖清单（全量/子集/隔离缓存/覆盖/失败/离线）并勾选 1.1
- User: 执行任务1.2  
- Assistant: 补充分层断言（缓存结构/metadata/退出码/日志/离线等）并勾选 1.2  
- User: 执行任务1.3  
- Assistant: 补充远端同步覆盖场景并勾选 1.3
- User: 执行任务2.1  
- Assistant: 添加在线同步模拟测试用例（xfail，覆盖全量/子集/失败保留缓存）并勾选 2.1  
- User: 执行任务2.2  
- Assistant: 补充失败/离线场景断言并勾选 2.2
- User: 执行任务3.1  
- Assistant: CLI 增加 --regulations 多值参数占位并勾选 3.1
- User: 执行任务3.2  
- Assistant: 添加 sync_regulations（按法规隔离落地、覆盖旧版、默认法规列表）并勾选 3.2
- User: 执行任务3.3  
- Assistant: 完成离线缺少缓存的失败校验并勾选 3.3
- User: 执行任务4.1  
- Assistant: 同步法规默认保留最新版本并通过测试  
- User: 执行任务4.2  
- Assistant: 标记缓存覆盖策略与 metadata 目标完成
- User: 执行任务5.1  
- Assistant: 更新 README 说明在线 rulesync/法规子集/缓存与离线模式，并勾选 5.1
- User: 执行任务5.2  
- Assistant: 补充验收用例（全量/子集/校验失败/离线缓存/覆盖旧版/日志与退出码）并勾选 5.2
- User: 标记任务5完成  
- Assistant: 标记 Story-9 任务 5 完成
- User: 在 Story-9 补充远端在线同步任务  
- Assistant: 新增任务 6（远端 HTTP/git/OCI 同步实现）
- User: 执行任务4.1  
- Assistant: 强化按法规缓存目录和仅保留最新版本的测试，准备勾选 4.1
- User: 标记任务3完成  
- Assistant: 标记 Story-9 任务 3 完成
