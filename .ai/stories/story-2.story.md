# Epic-2 - Story-1
# 地区→法规映射配置与高级选择

**As a** 合规/产品配置人员  
**I want** 在 UI/配置中按地区多选自动映射法规，并可手动增删法规，报告标注来源  
**so that** 扫描规则集与发布地区保持一致，且支持高级定制

## Status

Approved

## Context

- Epic-2 聚焦地区/法规映射，是扫描入口前置：先确定地区→法规集合，再加载规则。  
- PRD 要求：UI 默认多选地区自动映射法规，提供高级模式手动增删；报告标注规则来源（地区映射/手动）。  
- 需支持可扩展地区列表和法规列表；并集策略：地区多选时法规取并集，手动调整后以最终选择为准。

## Estimation

Story Points: 2

## Tasks

1. - [ ] 设计测试用例（TDD 先行）  
   1. - [ ] 覆盖：单地区映射、多地区并集、手动增删法规、默认列表加载、报告来源标记、无效输入/缺省处理  
   2. - [ ] 定义断言：映射结果、最终法规集合、来源标记字段、配置持久化/读取、错误提示  
2. - [ ] 实现地区/法规数据源加载  
   1. - [ ] 加载可选地区与默认映射表（支持扩展/覆盖）  
   2. - [ ] 加载可选法规集合，支持自定义扩展  
3. - [ ] 组合逻辑与 API/配置接口  
   1. - [ ] 输入：地区列表、多选，返回映射法规并集  
   2. - [ ] 高级模式：手动增删法规，输出最终法规集合与来源标记（映射/手动）  
   3. - [ ] 配置持久化/读取（如 config 文件或 CLI 参数解析）  
4. - [ ] 报告与下游接口  
   1. - [ ] 将地区/法规选择结果和来源标记输出给扫描器/报告生成器  
   2. - [ ] 报告字段：地区列表、法规列表、来源标记（地区映射/手动）  
5. - [ ] 日志与校验  
   1. - [ ] stdout 摘要：选定地区、映射法规、手动调整结果  
   2. - [ ] 对缺失/无效地区或法规给出清晰错误/警告
6. - [ ] 文档与验收  
   1. - [ ] 说明默认映射表、可扩展方式、示例配置/命令  
   2. - [ ] 验收用例：单地区、多地区并集、手动添加法规、手动移除法规、报告标记检查

## Constraints

- 映射与手动调整的结果以最终并集为准；报告必须标注规则来源。  
- 支持无网/受限环境，映射表本地可配置。  
- 不上传任何数据。

## Data Models / Schema

- 映射配置示例（YAML/JSON）：

```json
{
  "regions": ["EU", "US-CA"],
  "regulations": ["GDPR", "CCPA/CPRA"],
  "overrides": ["LGPD"],
  "source_flags": {
    "GDPR": "region",
    "CCPA/CPRA": "region",
    "LGPD": "manual"
  }
}
```

## Structure

- `config/regions.json|yaml`：地区与默认映射表  
- `config/regulations.json|yaml`：法规列表（可扩展）  
- `mapping/`：映射与合并逻辑模块  
- `cli/`：配置读取与输出接口（与 rulesync/扫描器对接）

## Diagrams

```mermaid
flowchart TD
    CFG["地区输入 (多选)"] --> MAP["映射表 -> 法规并集"]
    CFG --> MANUAL["手动增删法规"]
    MAP --> MERGE["合并 + 来源标记"]
    MANUAL --> MERGE
    MERGE --> OUT["输出: 最终法规集合 + 来源标记 -> 扫描器/报告"]
```

## Dev Notes

- 保证映射表可扩展/覆盖，避免写死在代码中。  
- 来源标记需贯穿到报告与扫描加载阶段，便于审计。  
- TDD：先定义映射与合并的测试，再实现逻辑。

## Chat Command Log

- User: 生成下一个 story  
- Assistant: 起草 Epic-2 Story-1（地区→法规映射配置）草稿
