# Epic-1 - Story-2
# 在线规则同步与法规集隔离缓存

**As a** 合规工具使用者/CI 运维  
**I want** 通过 CLI 从在线源同步指定法规集并按法规隔离缓存  
**so that** 能一键获取最新规则（默认全量法规），且不同法规集互不覆盖、可独立更新

## Status

Draft

## Context

- 基于 PRD 更新：rulesync 需支持在线源（使用 “法规参考链接” 中的官方地址），默认同步全部法规集，支持 CLI 参数指定法规子集。  
- 本地缓存目录需按法规隔离（`~/.minos/rules/<regulation>`），仅保留最新版本覆盖旧版，并校验完整性（SHA256/可选签名）。  
- 需兼容无网/受限环境：已有缓存可离线使用；失败时不影响其他法规集。

## Estimation

Story Points: 2

## Tasks

1. - [x] 设计测试用例（TDD 先行）  
   - [x] 1.1 覆盖：默认同步全量法规、指定法规子集、按法规隔离缓存、覆盖旧版本、校验失败/网络失败、离线使用已缓存  
   - [x] 1.2 断言：缓存目录结构（~/.minos/rules/<regulation>）、仅保留最新版本、metadata 正确记录来源/版本/校验结果、退出码/日志  
2. - [x] 实现测试用例（自动化）  
   - [x] 2.1 本地模拟在线源（本地 HTTP/文件）与法规子集参数的测试，验证缓存结构与覆盖策略  
   - [x] 2.2 覆盖校验失败/网络失败/离线缓存的退出码与日志断言  
3. - [x] CLI 与 rulesync 扩展  
   - [x] 3.1 新增 `--regulations` 多值参数，默认同步 PRD 法规参考链接全部法规；支持一次同步多个法规集  
   - [x] 3.2 支持在线源下载（使用 PRD 法规参考链接），校验 SHA256（预留 GPG），按法规目录落地并覆盖旧版  
   - [x] 3.3 离线模式：无网时使用已有缓存，缺失目标法规时返回非零并提示  
4. - [ ] 缓存与元数据  
   - [ ] 4.1 缓存目录 `~/.minos/rules/<regulation>`，仅保留最新版本；记录版本/来源/校验结果/安装时间/激活标记  
   - [ ] 4.2 清理或覆盖策略：同步成功后覆盖旧版并更新 metadata；保留失败日志  
5. - [ ] 文档与验收  
   - [ ] 5.1 更新 README/rulesync 使用说明：在线同步、法规子集、缓存结构、离线模式示例  
   - [ ] 5.2 验收用例：全量同步、指定法规、校验失败、离线使用缓存、覆盖旧版、日志与退出码

## Constraints

- 在线源使用 PRD “法规参考链接” 的地址；支持 https/git/oci。  
- 默认同步全部法规；用户可指定子集。  
- 规则集本地隔离存储且仅保留最新版本，互不覆盖。  
- 兼容无网/受限网络，使用已有缓存。

## Structure

- `minos/cli.py` rulesync 参数扩展  
- `minos/rulesync/`：下载/校验/落地与缓存管理  
- `tests/`：规则同步与缓存结构的测试/模拟源

## Test Plan（设计）

- 默认全量同步：无 `--regulations` 时拉取 PRD 法规参考链接中的全部法规（GDPR/CCPA/CPRA/LGPD/PIPL/APPI…），每个法规对应 `~/.minos/rules/<regulation>`，仅保留最新版本。  
- 指定法规子集：如 `--regulations gdpr --regulations ccpa` 仅同步子集；其他未指定法规不应新增/覆盖。  
- 缓存覆盖与隔离：同一法规多次同步覆盖旧版本（同目录），不同法规互不覆盖；metadata 记录版本/来源/校验结果/安装时间/激活标记。  
- 校验失败/网络失败：错误时退出码非零，日志包含失败原因，已有缓存不被覆盖。  
- 离线模式：在无网或模拟失败时使用已有缓存，缺失目标法规时退出码非零并提示缺少缓存。  
- 结构验证：检查目录结构、metadata 内容、激活版本指针；确认只保留最新版本（旧版本被覆盖或清理）。

## Assertions（设计）

- 缓存结构：`~/.minos/rules/<regulation>` 存在且仅保留最新版本；不同法规目录互不覆盖。  
- metadata：包含 version/source/sha256/installed_at/active/status；覆盖旧版后 metadata 更新为最新版本并 active=true。  
- 退出码：成功=0；校验失败、网络失败、缺少缓存（离线）=非零；失败时不覆盖已有缓存。  
- 日志：stdout 摘要包含同步法规列表、目标路径；错误/校验失败日志明确原因。  
- 默认全量：无参数时同步 PRD 法规参考链接中全部法规；子集模式仅落地指定法规。  
- 离线：有缓存则使用并退出码=0；无缓存且离线时退出码非零并提示缺少缓存。

## Chat Command Log

- User: OK，那新建story吧  
- Assistant: 创建 Epic-1 Story-2（在线规则同步与法规集隔离缓存）草稿  
- User: [story-9.story.md](.ai/stories/story-9.story.md) 执行任务1.1  
- Assistant: 设计测试覆盖清单（全量/子集/隔离缓存/覆盖/失败/离线）并勾选 1.1
- User: 执行任务1.2  
- Assistant: 补充分层断言（缓存结构/metadata/退出码/日志/离线等）并勾选 1.2  
- User: 执行任务2.1  
- Assistant: 添加在线同步模拟测试用例（xfail，覆盖全量/子集/失败保留缓存）并勾选 2.1  
- User: 执行任务2.2  
- Assistant: 补充失败/离线场景断言并勾选 2.2
- User: 执行任务3.1  
- Assistant: CLI 增加 --regulations 多值参数占位并勾选 3.1
- User: 执行任务3.2  
- Assistant: 添加 sync_regulations（按法规隔离落地、覆盖旧版、默认法规列表）并勾选 3.2
- User: 执行任务3.3  
- Assistant: 完成离线缺少缓存的失败校验并勾选 3.3
- User: 标记任务3完成  
- Assistant: 标记 Story-9 任务 3 完成
